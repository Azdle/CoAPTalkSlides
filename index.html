<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>The Constrained Application Protocol</title>

		<meta name="description" content="The IETF's New Protocol for the Internet of Things">
		<meta name="author" content="Patrick Barrett">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css" id="theme">

		<!--<script src="https://rawgit.com/azdle/dump.js/master/src/dump-min.js"></script>-->

		<!-- Local Style Overrides -->
		<style type="text/css">
			.reveal pre{
				width:105%;
			}

			.reveal pre code{
				padding: 1em;
			}
		</style>

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!-- my local scripts -->
		<script>
			var PING = new Uint8Array([64,0,0,0]);
			var WRITE = new Uint8Array([0x40, 0x01, 0x00, 0x37, 0xB2, 0x31, 0x61, 0x04, 0x74, 0x65, 0x6D, 0x70, 0x4D, 0x07, 0xA3, 0x2C, 0x85, 0xBA, 0x9D, 0xDA, 0x45, 0x82, 0x3B, 0xE4, 0x16, 0x24, 0x6C, 0xF8, 0xB4, 0x33, 0xBA, 0xA0, 0x68, 0xD7]);

			var Dump = (function() {
				//
				// Constructor
				//

				function Dump(options) {
					this.options = {
						wordLength: options.wordLength || 8,
						wordsPerLine: options.wordsPerLine || 16,
						lineNumbers: options.lineNumbers || false,
						lineNumberDigits: options.lineNumberDigits || 8,
						lineNumberSeperator: options.lineNumberSeperator || ": ",
						asciiPreview: options.asciiPreview || false,
						asciiPreviewReplacer: options.asciiPreviewReplacer || ".",//"ï¿½",
						asciiPreviewSeperator: options.asciiPreviewSeperator || "  ",
						lineSeperator: options.lineSeperator || "\n",
						wordSeperator: options.wordSeperator || " ",
						wordPrepend: options.wordPrepend || "",
						wordAppend: options.wordAppend || ""
					};
				}

				//
				// Private Functions
				//
				
				function prepad(str, num, prepender) {
					while (str.length < num) {
						str = prepender.concat(str);
					}

					return str
				}

				function toPrintableAscii(code, replacer) {
					if (code >= 0x32 && code <= 0x7E) {
						return String.fromCharCode(code);
					} else {
						return replacer;
					}
				}

				//
				// Public Functions
				//

				Dump.prototype.dump = function(data) {
					var dumps = "";

					if (typeof(data) === "object" && data.constructor === ArrayBuffer) {
						data = new Uint8Array(data)
					}

					if (typeof(data) !== "object" || data.constructor !== Uint8Array) {
						console.error("Can only bump Uint8Array.")
					}

					var asciiPreviewLine = "";
					for(var i in data){
						i = parseInt(i)
						if (this.options.lineNumbers == true && i % this.options.wordsPerLine == 0) {
							dumps = dumps + prepad(i.toString(16), this.options.lineNumberDigits, "0") + this.options.lineNumberSeperator;
						}

						asciiPreviewLine = asciiPreviewLine + toPrintableAscii(data[i], this.options.asciiPreviewReplacer);

						dumps = dumps + 
						        this.options.wordPrepend + 
						        prepad(data[i].toString(16), 2, "0") + 
						        this.options.wordAppend;

						if (((i+1) % this.options.wordsPerLine) === 0 || i === data.length-1) {
							if (i === data.length-1) {
								var wordsLeft = this.options.wordsPerLine - ((i+1) % this.options.wordsPerLine);
								var spacerLength = (this.options.wordPrepend.length +
								                    2 + //this.wordLength
								                    this.options.wordAppend.length +
								                    this.options.wordSeperator.length) * wordsLeft;

								var spacer = Array(spacerLength + 1).join(" ");
								dumps = dumps + spacer; 
								
							}

							if (this.options.asciiPreview === true) {
								dumps = dumps + this.options.asciiPreviewSeperator;
								dumps = dumps + asciiPreviewLine;
							}
							asciiPreviewLine = "";

							if (i !== data.length-1) {
								dumps = dumps + this.options.lineSeperator;
							}
						} else {
							dumps = dumps + this.options.wordSeperator;
						}
					}

					return dumps;
				}

				Dump.prototype.parse = function(dump) {
					var data = new ArrayBuffer();

					return data;
				}

				return Dump;
			})()

			var dumper = new Dump({
				lineNumbers: true,
				asciiPreview: true,
			});

			var WebDatagramSocket = (function() {
				//
				// Constructor
				//

				function WebDatagramSocket(host, port) {
					this.host = host;
					this.port = port;
	
					// callback that gets the message as a UInt8Array
					this.onmessage = null;
	
					// setup websocket connection to proxy
					this.ws = new WebSocket("wss://webdatagram.herokuapp.com/"+host+"/"+port+"/", ["wdp"]);
					this.ws.binaryType = "arraybuffer";
					this.ws.connection_time = Date.now();
	
					function handleIncomingMessage(event){
						var buf = new Uint8Array(event.data);

						if(typeof(this.onmessage) === "function"){
							this.onmessage(buf)
						}
					}
	
					this.ws.onmessage = handleIncomingMessage.bind(this);

					function handleClose(event){
						console.log("Websocket Closed with", event.reason, event.code)

						if (event.code === 1006){
							console.log("Seconds since open: ", (Date.now() - this.ws.connection_time)/1000);
							if(this.ws.connection_time < (Date.now() - 5000)){
								console.log("Abnormal Close, Re-creating Websocket")
								new_ws = new WebSocket("wss://webdatagram.herokuapp.com/"+this.host+"/"+this.port+"/", ["wdp"]);
								new_ws.binaryType = "arraybuffer";
								new_ws.onmessage = handleIncomingMessage.bind(this);
								new_ws.onclose = handleClose.bind(this);
								//new_ws.onerror = this.ws.onerror;
								new_ws.connection_time = Date.now();

								this.ws = new_ws;
							} else {
								console.error("Abnormal Close within 5 sec, not Re-creating");
								//console.debug(this.ws.connection_time, Date.now(), (Date.now() - 5000));
							}
						}
					}

					this.ws.onclose = handleClose.bind(this);

					function handleError(event){
						console.log("Websocket Error:", event.reason, event.code)
					}

					//this.ws.onerror = handleError.bind(this);
	
				}

				//
				// Public Functions
				//

				WebDatagramSocket.prototype.send = function(buf) {
						return this.ws.send(buf);
				}

				return WebDatagramSocket;
			})()

			var wd = new WebDatagramSocket("coap.exosite.com", 5683);

		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>The Constrained Application Protocol</h1>
					<h3>The IETF's New Protocol for the Internet of Things</h3>
					<p>
						<small><a href="http://mkii.org">Patrick Barrett</a> / <a href="http://twitter.com/@zdle">@zdle</a></small>
					</p>
				</section>

				<section>
					<h1>But First</h1>
				</section>

				<section>
					<h2>Bla, Bla, Bla</h2>
					<pre><code data-trim class="http request">
POST /api:v1/stack/alias HTTP/1.1
Host: m2.exosite.com
X-Exosite-CIK: a32c85ba9dda45823be416246cf8b433baa068d7
Content-Type: application/x-www-form-urlencoded; charset=utf-8
Content-Length: 7

temp=26
					</code></pre>
					<pre><code data-trim class="http response">
HTTP/1.1 204 No Content
Date: Thu, 05 Mar 2015 18:00:44 GMT
Content-Length: 0
Server: nginx
 
&nbsp;
					</code></pre>
				</section>

				<section>
					<h2>Yo!</h2>
					<pre><code data-trim class="request coap" id="yo-request">
00000000: 40 01 00 37 B2 31 61 04  74 65 6D 70 4D 07 A3 2C  @..7.1a.tempM..,
00000010: 85 BA 9D DA 45 82 3B E4  16 24 6C F8 B4 33 BA A0  ....E.;..$l..3..
00000020: 68 D7                                             h.
					</code></pre>
					<pre><code data-trim class="response coap" id="yo-response">
00000000: 60 44 00 37                                       `D.7
					</code></pre>
				</section>

				<section class="worse">
					<h2>It's Worse than it Looks</h2>
					<pre><code data-trim class="request coap" id="worse-request">
00000000: 40 02 00 37 B2 31 61 04  74 65 6D 70 4D 07 A3 2C  @..7.1a.tempM..,
00000010: 85 BA 9D DA 45 82 3B E4  16 24 6C F8 B4 33 BA A0  ....E.;..$l..3..
00000020: 68 D7 FF 32 36                                    h..26
					</code></pre>
					<pre><code data-trim class="request http" id="worse-response">
00000000: 50 4F 53 54 20 2F 61 70  69 3A 76 31 2F 73 74 61  POST /api:v1/sta
00000010: 63 6B 2F 61 6C 69 61 73  20 48 54 54 50 2F 31 2E  ck/alias HTTP/1.
00000020: 31 0A 48 6F 73 74 3A 20  6D 32 2E 65 78 6F 73 69  1.Host: m2.exosi
00000030: 74 65 2E 63 6F 6D 0A 58  2D 45 78 6F 73 69 74 65  te.com.X-Exosite
00000040: 2D 43 49 4B 3A 20 61 33  32 63 38 35 62 61 39 64  -CIK: a32c85ba9d
00000050: 64 61 34 35 38 32 33 62  65 34 31 36 32 34 36 63  da45823be416246c
00000060: 66 38 62 34 33 33 62 61  61 30 36 38 64 37 0A 43  f8b433baa068d7.C
00000070: 6F 6E 74 65 6E 74 2D 54  79 70 65 3A 20 61 70 70  ontent-Type: app
00000080: 6C 69 63 61 74 69 6F 6E  2F 78 2D 77 77 77 2D 66  lication/x-www-f
00000090: 6F 72 6D 2D 75 72 6C 65  6E 63 6F 64 65 64 3B 20  orm-urlencoded; 
000000A0: 63 68 61 72 73 65 74 3D  75 74 66 2D 38 0A 43 6F  charset=utf-8.Co
000000B0: 6E 74 65 6E 74 2D 4C 65  6E 67 74 68 3A 20 37 0A  ntent-Length: 7.
000000C0: 0A 74 65 6D 70 3D 32 36                           .temp=26
					</code></pre>
				</section>

				<section>
					<script type="text/javascript">
						function doRoar(){
							wd.onmessage = null;
							wd.onmessage = function(ab){
								var currentText = document.getElementById("roar-response").textContent;
								if (currentText == ""){
									document.getElementById("roar-response").textContent += dumper.dump(ab);
								} else {
									document.getElementById("roar-response").textContent += "\n\n" + dumper.dump(ab);
								}
							}
							wd.send(WRITE);
						}

						document.addEventListener('readystatechange', function() {
							document.getElementById("roar-request").textContent = dumper.dump(WRITE)
						}, false);
					</script>
					<h2>Hear me roar!</h2>
					<input type=button name="doit" value="Do It!" onclick="doRoar();"/>
					<input type=button name="doit" value="Clear" onclick="document.getElementById('roar-response').textContent = ''"/>
					<pre><code data-trim class="roar coap hexdump request" id="roar-request">
00000000: 40 01 00 37 B2 31 61 04  74 65 6D 70 4D 07 A3 2C  @..7.1a.tempM..,
00000010: 85 BA 9D DA 45 82 3B E4  16 24 6C F8 B4 33 BA A0  ....E.;..$l..3..
00000020: 68 D7                                             h.
					</code></pre>
					<pre><code data-trim class="roar coap hexdump response" id="roar-response"></code></pre>
				</section>

				<section>
					<p><small>
						The Constrained Application Protocol (CoAP) is a specialized web
						transfer protocol for use with constrained nodes and constrained
						(e.g., low-power, lossy) networks.  The nodes often have 8-bit
						microcontrollers with small amounts of ROM and RAM, while constrained
						networks such as IPv6 over Low-Power Wireless Personal Area Networks
						(6LoWPANs) often have high packet error rates and a typical
						throughput of 10s of kbit/s.  The protocol is designed for machine-
						to-machine (M2M) applications such as smart energy and building
						automation.
					</small></p>

					<p><small>
						CoAP provides a request/response interaction model between
						application endpoints, supports built-in discovery of services and
						resources, and includes key concepts of the Web such as URIs and
						Internet media types.  CoAP is designed to easily interface with HTTP
						for integration with the Web while meeting specialized requirements
						such as multicast support, very low overhead, and simplicity for
						constrained environments.
					</small></p>
				</section>

				<section>
					<p>Other things to hit: TCP Connection time, Server to Server, Multicast, discoverability,
						group communication, Thread, 6LoWPAN</p>

					<p>Things that are crap: DTLS vs TLS</p>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>
		<script src="https://rawgit.com/mephux/hexdump.js/master/src/hexdump-min.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
